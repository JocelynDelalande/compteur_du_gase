{% extends "base/base.html" %}

{% block content %}
<div class="row">
    <h2>Foyers et membres</h2>
</div>
<div class="row">
    <h6>
	Cette page sert à :
	 <ul>
	  <li>créer un nouveau foyer ;</li>
	  <li>obtenir des informations sur un foyer.</li>
	</ul>
	</h6>
</div>
<div class="row justify-content-center">
  <a class="btn btn-info" href="{% url 'base:create_household' %}">Créer un nouveau foyer</a>
</div>

<div id="vue-table">

  <form>
      <input type="text" v-model="search" class="form-control" placeholder="Tapez pour filtrer ...">
  </form>

  <table class="table table-striped">
    <thead>
      <tr>
        <th v-for="column in columns" @click="sortBy(column)" :class="{ active: sortKey == column }">
	  [[ _.capitalize(column) ]]
	  [[ sortKey == column ? (reverse ? "⯅" : "⯆") : ""]]
        </th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <tr v-for="x in filter()">
        <td v-for="column in columns">
	  [[ x[column] ]]
	</td>
        <td><a :href="'membre/' + x.household_id">⌬ Détails du foyer</a></td>
      </tr>
    </tbody>
  </table>

</div>

<script>
  new Vue({
      delimiters: ['[[', ']]'],
      el: '#vue-table',
      data: {
	  sortKey: 'nom',
	  search: '',
	  reverse: false,
	  columns: {{ columns | safe }},

	  raw_data: {{ members | safe }}
      },

      computed: {
	  orderedData: function () {
	      var data = _.orderBy(this.raw_data, this.sortKey);
	      if (this.reverse) {
		  return _.reverse(data)
	      } else {
		  return data
	      }
	  }
      },

      methods: {
	  sortBy: function(sortKey) {
	      this.reverse = (this.sortKey == sortKey) ? ! this.reverse : false;
	      this.sortKey = sortKey
	  },

	  filter: function () {
	      var filterKey = this.search.toLowerCase();
	      var data = this.orderedData;
	      data = data.filter(function (row) {
		  return Object.keys(row).some(function (key) {
		      return String(row[key]).toLowerCase().indexOf(filterKey) > -1
		  })
              });
	      return data
	  }
      }
  })
</script>
{% endblock %}
