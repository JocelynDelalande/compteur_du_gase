{% extends 'base/base.html' %}
{% load crispy_forms_tags %}

{% block navbar %}
{% endblock navbar %}


{% block content %}
<div id="vue-table">

<div class="row justify-content-left">
  <a class="btn btn-info" href="{% url 'base:index' %}" onclick="return confirm('Voulez-vous vraiment abandonner vos achats et revenir √† l\'acceuil ? (Vous n\'avez pas pay√©)')">Abandonner et revenir √† l'accueil</a>
</div>

<div class="row justify-content-center bg-primary">
  <button @click="category=''" class="btn btn-info">Toutes cat√©gories</button>&nbsp;
  {% for cat in cats %}
  <button @click="category='{{ cat.pk }}'" class="btn btn-info">{{ cat.name }}</button>&nbsp;
  {% endfor %}
</div>


<div class="row justify-content-center bg-dark">
  Nom : {{ household.name }} <br>
  Solde : {{ household.account }}
</div>

<div class="row">

  <div class="col col-6 bg-warning">

    <form>
      <input type="text" v-model="search" class="form-control" placeholder="Tapez pour filtrer ...">
    </form>

    <table class="table table-striped">
      <thead>
	<tr>
          <th>Nom</th>
          <th>Prix au kilo</th>
          <th>Quantit√©</th>
	</tr>
      </thead>
      <tbody>
	<tr v-for="(pdt, id) in filter()">
          <td>[[ pdt.name ]]</td>
          <td>[[ pdt.price ]]</td>
          <td>
	    <input type="number" class="numberinput form-control" @keyup.enter="inBasket" :id="'input_pdt_' + id">	    
	  </td>
	</tr>
      </tbody>
    </table>  
    <div class="text-right">
      <button class="btn btn-primary" @click="inBasket" >Dans panier !</button>
    </div>
  </div>

  <div class="col col-6 bg-info">
    <form action="" @submit="validateForm" method="post">
    {% csrf_token %}
    <table class="table table-striped">
      <thead>
	<tr>
          <th>Nom</th>
          <th>Quantit√©</th>
          <th>Prix</th>
          <th></th>
	</tr>
      </thead>
      <tbody>
	<tr v-for="(qtity, id) in basket">
          <td>[[ pdts[id].name ]]</td>
          <td>[[ qtity ]]</td>
          <td>[[ pdts[id].price * qtity ]]</td>
          <td><a @click="removeBasket(id)">üóë</a></td>
	  <input type="hidden" :value="qtity" :name="'basket_' + id" :id="'basket_' + id">
	</tr>
      </tbody>
    </table>
    <div class="row">
      <div class="col">
	<strong>Montant total : [[ totalAmount() ]] ‚Ç¨</strong>
      </div>
      <div class="col">
	Montant max : {{ max_amount }} ‚Ç¨
      </div>
      <div class="col bg-primary text-right">
	<input class="btn btn-info" type="submit" value="Payer">
      </div>
    </form>
    </div>
  </div>
</div>
</div>

<script>
  new Vue({
      delimiters: ['[[', ']]'],
      el: '#vue-table',
      data: {
	  search: '',
	  category: '',
	  pdts: {{ pdts | safe }},
	  basket: {}
      },

      methods: {
	  filter: function () {
	      var search = this.search; // important de faire √ßa sinon this.truc r√©f√®re √† je sais pas quoi qui est undefined
	      var category = this.category;
	      return _.pickBy(this.pdts, (function (row) {
		  var b = (category.length == 0) || (row.category == category)
		  return b && myContains(row.name, search)
		  }))
	  },

	  inBasket: function () {
	      var filtered = this.filter();
	      for (var id in filtered) {
		  var input = document.getElementById("input_pdt_" + id);
		  if (input.value) {
		      var value = Number(input.value);
		      if (value == 0) {
			  input.value = '';
		      } else {
			  if (value < 0) {
			      alert("Vous avez rentr√© une quantit√© n√©gative. Cela peut √™tre pratique pour rattraper une erreur dans un achat pr√©c√©dent. Mais si vous vous √™tes tromp√©, supprimez la r√©f√©rence de votre panier.");
			  }
			  if(!this.pdts[id].vrac && !Number.isInteger(value)) {
			      alert("Veuillez utiliser un nombre entier pour: " + this.pdts[id].name);
			  } else {
			      var before = (this.basket[id]) ? (this.basket[id]) : 0;
			      Vue.set(this.basket, id, before + value);
			      input.value = '';
			  }
		      }
		  }
	      }
	  },

	  removeBasket: function(id) {
	      Vue.delete(this.basket, id)
	  },

	  totalAmount: function () {
	      var s = 0
	      for (var id in this.basket) {
		  s += this.pdts[id].price * this.basket[id]
	      }
	      return s
	  },

	  validateForm: function(e) {
	      if (Object.keys(this.basket).length == 0) {
		  alert ("Votre panier est vide");
		  e.preventDefault()
	      }
	      if (this.totalAmount() >= {{ max_amount }}) {
		  alert ("Vous n'avez pas assez de sous sur votre compte !");
		  e.preventDefault()
	      }
	  }
      }
  })
</script>
{% endblock content %}
